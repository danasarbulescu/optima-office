version: 1
backend:
  phases:
    build:
      commands:
        - npm ci --cache .npm --prefer-offline
        - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --cache .npm --prefer-offline
    build:
      commands:
        - npm run build
        - mkdir -p .amplify-hosting/static
        - cp -r dist/* .amplify-hosting/static/
        - |
          cat > .amplify-hosting/deploy-manifest.json << 'EOF'
          {
            "version": 1,
            "routes": [
              {
                "path": "/assets/*",
                "target": {
                  "kind": "Static",
                  "cacheControl": "public, max-age=31536000, immutable"
                }
              },
              {
                "path": "/*",
                "target": {
                  "kind": "Static"
                },
                "fallback": {
                  "target": "/index.html",
                  "statusCode": 200
                }
              }
            ],
            "computeResources": [],
            "framework": {
              "name": "vite",
              "version": "6.4.1"
            }
          }
          EOF
  artifacts:
    baseDirectory: .amplify-hosting
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .npm/**/*
