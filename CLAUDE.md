# QuickBooks Export

Web dashboard and CLI tool that fetches P&L data from CData Connect Cloud and renders a financial dashboard. Deployed on AWS Amplify with Cognito authentication.

## Workflows

- **Web app**: `npm run dev` — local Vite dev server (requires `npx ampx sandbox` running for backend)
- **CLI**: `npm run report -- --month YYYY-MM` — generates `output/dashboard.html` directly
- **Build**: `npm run build` — Vite production build to `dist/`

## Project structure

```
amplify/
  auth/resource.ts                  — Cognito auth (email, no self-signup)
  functions/dashboard-api/
    resource.ts                     — Lambda function definition with CData secrets
    handler.ts                      — Lambda handler: CData fetch + compute + JSON response
  backend.ts                        — defineBackend, HTTP API with Cognito authorizer
src/
  lib/
    types.ts                        — Shared interfaces (KPIs, PnLByMonth, CDataPLRow, etc.)
    cdata.ts                        — CData API client (parameterized credentials)
    compute.ts                      — buildGroupValues, computeKPIs, build13MonthPnL
    format.ts                       — formatAbbrev, formatPct, formatVariance
    html.ts                         — generateHTML, generatePnLTableHTML
  frontend/
    index.html                      — Vite entry HTML
    main.tsx                        — React root with Amplify Authenticator
    App.tsx                         — Dashboard shell: month selector, API call, render
    App.css                         — App shell styles
  generate-report.ts                — CLI entry point (preserved)
  cdata.ts                          — CLI CData wrapper (reads .env, delegates to lib/)
output/
  dashboard.html                    — Generated by CLI (not committed)
```

## Environment

- **Runtime**: Node.js + Vite (frontend), Lambda (backend)
- **Language**: TypeScript (strict mode, ES2020 target)
- **Frontend**: React 18 + Vite + @aws-amplify/ui-react
- **Backend**: AWS Amplify Gen 2 (Cognito, Lambda, HTTP API Gateway)
- **Key dependencies**: axios, aws-amplify, react
- **CLI config**: `.env` file with `CDATA_USER`, `CDATA_PAT`, `CDATA_CATALOG`
- **Lambda secrets**: Set via `npx ampx sandbox secret set` (local) or Amplify Console > Secrets (production)

## CData integration (`src/lib/cdata.ts`)

- **Endpoint**: `POST https://cloud.cdata.com/api/query` with Basic Auth (username + PAT)
- **SQL query**: `SELECT * FROM {catalog}.QuickBooksOnline.PL WHERE RowType = 'Summary' AND RowId IS NULL`
- **Table format**: `{catalog}.{schema}.{table}` (e.g. `BrooklynRestaurants.QuickBooksOnline.PL`)
- **PL table columns**: `account`, `RowGroup`, `RowType`, `RowId`, monthly columns (`Jan_2024` through `Dec_2026`), `Total`
- **RowGroups**: Income, COGS, GrossProfit, Expenses, NetOperatingIncome, OtherIncome, OtherExpenses, NetOtherIncome, NetIncome
- `buildGroupValues(rows, year)` — extracts monthly values for a given year into `Map<string, number[]>` (indices 0-11 = Jan-Dec, 12 = computed total)

## Dashboard

The dashboard is a self-contained HTML template with inline CSS:
- **9 KPI cards** in 2 rows: Revenue, Gross Margin, Net Income, YTD/YOY comparisons
- **13-month P&L table**: trailing window relative to selected month

Key functions in `src/lib/`:
- `computeKPIs(curGroups, pyGroups, monthIdx)` — derives all dashboard metrics
- `build13MonthPnL(curGroups, pyGroups, selectedMonth)` — builds 13-month trailing P&L data
- `generateHTML(kpis, selectedMonth, pnlByMonth)` — renders the full dashboard HTML

## API

- **Endpoint**: `GET /dashboard?month=YYYY-MM` (Cognito-protected)
- **Response**: `{ kpis: KPIs, pnlByMonth: PnLByMonth, selectedMonth: string }`
- Frontend calls `generateHTML()` client-side with the JSON response

## npm scripts

- `npm run dev` — Vite dev server (frontend)
- `npm run build` — Vite production build
- `npm run report -- --month YYYY-MM` — CLI dashboard generation
- `npm run start:cli -- --month YYYY-MM` — alias for CLI

## Local development

```bash
# Terminal 1: Deploy sandbox backend
npx ampx sandbox

# Terminal 2: Start frontend
npm run dev
```

## Authentication

Cognito User Pool with `allowAdminCreateUserOnly: true`. Create users via:
```bash
aws cognito-idp admin-create-user --user-pool-id <ID> --username user@email.com \
  --temporary-password TempPass123! \
  --user-attributes Name=email,Value=user@email.com Name=email_verified,Value=true
```
